<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ранглиста Тенис на Маса</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            overflow-x: auto;
        }
        
        .nav-tab {
            padding: 15px 30px;
            cursor: pointer;
            border: none;
            background: transparent;
            font-size: 16px;
            font-weight: 500;
            color: #495057;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .nav-tab:hover {
            background: #e9ecef;
        }
        
        .nav-tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }
        
        .content {
            padding: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .ranking-position {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
        }
        
        .ranking-gold {
            color: #FFD700;
        }
        
        .ranking-silver {
            color: #C0C0C0;
        }
        
        .ranking-bronze {
            color: #CD7F32;
        }
        
        .search-filter {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .card h3 {
            margin-bottom: 15px;
            color: #667eea;
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .match-result {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .player-info {
            flex: 1;
            text-align: center;
        }
        
        .vs-separator {
            padding: 0 20px;
            font-weight: bold;
            color: #667eea;
        }
        
        .points-change {
            font-weight: bold;
            margin-top: 5px;
        }
        
        .points-gain {
            color: #28a745;
        }
        
        .points-loss {
            color: #dc3545;
        }
        
        .month-selector {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .month-selector button {
            padding: 8px 15px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-card h4 {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
        }
        
        .stat-card p {
            font-size: 2em;
            font-weight: bold;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 14px;
        }

        .export-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
        }

        .autocomplete-container {
            position: relative;
        }

        .autocomplete-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .autocomplete-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #667eea;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .autocomplete-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s;
        }

        .autocomplete-item:hover {
            background: #f8f9fa;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-item-highlight {
            background: #e9ecef;
        }

        .player-search-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .player-name {
            font-weight: 600;
            color: #333;
        }

        .player-details {
            font-size: 12px;
            color: #666;
        }

        .player-license {
            color: #667eea;
            font-weight: 600;
        }

        .player-points {
            color: #28a745;
        }

        .selected-player-badge {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            margin-top: 8px;
            font-size: 14px;
        }

        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .login-modal {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 90%;
        }

        .login-modal h2 {
            color: #667eea;
            margin-bottom: 10px;
            text-align: center;
        }

        .login-modal p {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }

        .login-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .admin-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-left: 15px;
        }

        .guest-badge {
            background: #6c757d;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-left: 15px;
        }

        .header-actions {
            position: absolute;
            right: 30px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-container {
            position: relative;
        }

        .welcome-text {
            font-size: 0.9em;
            opacity: 0.95;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // Utility functions
        const generateId = () => '_' + Math.random().toString(36).substr(2, 9);
        
        const getCurrentMonth = () => {
            const now = new Date();
            return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        };

        const formatDateToDDMMYYYY = (dateString) => {
            if (!dateString) return '-';
            const [year, month, day] = dateString.split('-');
            return `${day}/${month}/${year}`;
        };

        const getAgeGroup = (dateOfBirth, gender) => {
            const today = new Date();
            const birth = new Date(dateOfBirth);
            const age = today.getFullYear() - birth.getFullYear();
            
            if (gender === 'Мъж') {
                if (age <= 11) return 'Момчета до 11г.';
                if (age <= 13) return 'МиниКадети';
                if (age <= 15) return 'Кадети';
                if (age <= 18) return 'Юноши Старша възраст';
                if (age <= 21) return 'Младежи до 21г.';
                return 'Мъже';
            } else {
                if (age <= 11) return 'Момичета до 11г.';
                if (age <= 13) return 'Мини Кадетки';
                if (age <= 15) return 'Кадетки';
                if (age <= 18) return 'Девойки Старша Възраст';
                if (age <= 21) return 'Девойки до 21г.';
                return 'Жени';
            }
        };

        const calculatePointsChange = (winnerPoints, loserPoints, isWinnerStronger) => {
            const diff = Math.abs(winnerPoints - loserPoints);
            
            let pointsChange = 0;
            
            if (diff <= 24) pointsChange = 6;
            else if (diff <= 49) pointsChange = 7;
            else if (diff <= 99) pointsChange = 8;
            else if (diff <= 149) pointsChange = 10;
            else if (diff <= 199) pointsChange = 13;
            else if (diff <= 299) pointsChange = 17;
            else if (diff <= 399) pointsChange = 22;
            else if (diff <= 499) pointsChange = 28;
            else pointsChange = 40;
            
            // If winner is stronger (more points), they gain less points (Logique)
            if (isWinnerStronger) {
                if (diff <= 24) return { winner: 6, loser: -6 };
                else if (diff <= 49) return { winner: 5, loser: -5 };
                else if (diff <= 99) return { winner: 4, loser: -4 };
                else if (diff <= 149) return { winner: 3, loser: -3 };
                else if (diff <= 199) return { winner: 2, loser: -2 };
                else if (diff <= 299) return { winner: 1, loser: -1 };
                else if (diff <= 399) return { winner: 0.5, loser: -0.5 };
                else return { winner: 0, loser: 0 };
            } else {
                // Winner is weaker (Performance/Perf)
                return { winner: pointsChange, loser: -pointsChange };
            }
        };

        function App() {
            const [activeTab, setActiveTab] = useState('ranking');
            const [currentMonth, setCurrentMonth] = useState(getCurrentMonth());
            
            // Authentication states
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [isAdmin, setIsAdmin] = useState(false);
            const [loginForm, setLoginForm] = useState({ username: '', password: '' });
            const [showLogin, setShowLogin] = useState(false);
            
            // Data states
            const [players, setPlayers] = useState([]);
            const [clubs, setClubs] = useState([]);
            const [tournaments, setTournaments] = useState([]);
            const [matches, setMatches] = useState([]);
            const [monthlyRankings, setMonthlyRankings] = useState({});
            
            // Form states
            const [playerForm, setPlayerForm] = useState({
                firstName: '', lastName: '', dateOfBirth: '', gender: 'Мъж',
                clubId: '', licenseNumber: '', initialPoints: 500
            });
            
            const [clubForm, setClubForm] = useState({
                name: '', city: '', clubNumber: ''
            });
            
            const [tournamentForm, setTournamentForm] = useState({
                name: '', startDate: '', endDate: '', location: '', hostClubId: '', coefficient: 1.0
            });
            
            const [matchForm, setMatchForm] = useState({
                tournamentId: '', player1Id: '', player2Id: '', 
                format: 'best-of-5', winnerId: '', score: ''
            });
            
            // Player search states
            const [player1Search, setPlayer1Search] = useState('');
            const [player2Search, setPlayer2Search] = useState('');
            const [showPlayer1Dropdown, setShowPlayer1Dropdown] = useState(false);
            const [showPlayer2Dropdown, setShowPlayer2Dropdown] = useState(false);
            const [selectedPlayer1, setSelectedPlayer1] = useState(null);
            const [selectedPlayer2, setSelectedPlayer2] = useState(null);
            
            // Filter states
            const [searchTerm, setSearchTerm] = useState('');
            const [filterClub, setFilterClub] = useState('');
            const [filterAgeGroup, setFilterAgeGroup] = useState('');
            
            const [alert, setAlert] = useState(null);
            const [editingPlayer, setEditingPlayer] = useState(null);
            const [editingClub, setEditingClub] = useState(null);
            const [editingTournament, setEditingTournament] = useState(null);

            // Load data from localStorage
            useEffect(() => {
                // First check for automatic backup
                const autoBackup = localStorage.getItem('tt_auto_backup');
                const backupTimestamp = localStorage.getItem('tt_backup_timestamp');
                
                let hasData = false;
                const savedPlayers = localStorage.getItem('tt_players');
                const savedClubs = localStorage.getItem('tt_clubs');
                const savedTournaments = localStorage.getItem('tt_tournaments');
                const savedMatches = localStorage.getItem('tt_matches');
                const savedRankings = localStorage.getItem('tt_monthly_rankings');
                
                // Check if we have any data in current storage
                hasData = savedPlayers || savedClubs || savedTournaments || savedMatches || savedRankings;
                
                // If we have a backup but no current data, offer to restore
                if (autoBackup && !hasData) {
                    const backup = JSON.parse(autoBackup);
                    const backupDate = backupTimestamp ? new Date(backupTimestamp).toLocaleString('bg-BG') : 'неизвестна дата';
                    
                    if (window.confirm(`Открит е автоматичен backup от ${backupDate}.\n\nИскате ли да възстановите данните?\n\nСъстезатели: ${backup.players?.length || 0}\nКлубове: ${backup.clubs?.length || 0}\nТурнири: ${backup.tournaments?.length || 0}\nМачове: ${backup.matches?.length || 0}`)) {
                        setPlayers(backup.players || []);
                        setClubs(backup.clubs || []);
                        setTournaments(backup.tournaments || []);
                        setMatches(backup.matches || []);
                        setMonthlyRankings(backup.monthlyRankings || {});
                        showAlert('Данните са възстановени успешно от автоматичния backup!', 'success');
                    }
                } else {
                    // Load normally
                    if (savedPlayers) setPlayers(JSON.parse(savedPlayers));
                    if (savedClubs) setClubs(JSON.parse(savedClubs));
                    if (savedTournaments) setTournaments(JSON.parse(savedTournaments));
                    if (savedMatches) setMatches(JSON.parse(savedMatches));
                    if (savedRankings) setMonthlyRankings(JSON.parse(savedRankings));
                }
                
                const savedAuth = localStorage.getItem('tt_is_admin');
                
                // Check if user was logged in as admin
                if (savedAuth === 'true') {
                    setIsAdmin(true);
                    setIsAuthenticated(true);
                }
            }, []);

            // Save data to localStorage
            useEffect(() => {
                localStorage.setItem('tt_players', JSON.stringify(players));
                createAutoBackup();
            }, [players]);

            useEffect(() => {
                localStorage.setItem('tt_clubs', JSON.stringify(clubs));
                createAutoBackup();
            }, [clubs]);

            useEffect(() => {
                localStorage.setItem('tt_tournaments', JSON.stringify(tournaments));
                createAutoBackup();
            }, [tournaments]);

            useEffect(() => {
                localStorage.setItem('tt_matches', JSON.stringify(matches));
                createAutoBackup();
            }, [matches]);

            useEffect(() => {
                localStorage.setItem('tt_monthly_rankings', JSON.stringify(monthlyRankings));
                createAutoBackup();
            }, [monthlyRankings]);

            // Create automatic backup of all data
            const createAutoBackup = () => {
                try {
                    const backup = {
                        players,
                        clubs,
                        tournaments,
                        matches,
                        monthlyRankings,
                        version: '1.0',
                        timestamp: new Date().toISOString()
                    };
                    localStorage.setItem('tt_auto_backup', JSON.stringify(backup));
                    localStorage.setItem('tt_backup_timestamp', new Date().toISOString());
                } catch (error) {
                    console.error('Грешка при създаване на автоматичен backup:', error);
                }
            };

            const showAlert = (message, type = 'success') => {
                setAlert({ message, type });
                setTimeout(() => setAlert(null), 3000);
            };

            // Authentication functions
            const handleLogin = () => {
                if (loginForm.username === 'admin' && loginForm.password === 'TT#Rank2026!vK$92mPx') {
                    setIsAdmin(true);
                    setIsAuthenticated(true);
                    localStorage.setItem('tt_is_admin', 'true');
                    setShowLogin(false);
                    showAlert('Успешно влязохте като администратор!');
                    setLoginForm({ username: '', password: '' });
                } else {
                    showAlert('Грешно потребителско име или парола!', 'error');
                }
            };

            const handleLogout = () => {
                setIsAdmin(false);
                setIsAuthenticated(false);
                localStorage.removeItem('tt_is_admin');
                showAlert('Излязохте от системата успешно!');
            };

            const enterAsGuest = () => {
                setIsAuthenticated(true);
                setIsAdmin(false);
                setShowLogin(false);
            };

            // Player CRUD
            const addOrUpdatePlayer = () => {
                if (!playerForm.firstName || !playerForm.lastName || !playerForm.dateOfBirth) {
                    showAlert('Моля попълнете всички задължителни полета!', 'error');
                    return;
                }

                const ageGroup = getAgeGroup(playerForm.dateOfBirth, playerForm.gender);
                
                if (editingPlayer) {
                    setPlayers(players.map(p => 
                        p.id === editingPlayer.id 
                            ? { ...p, ...playerForm, ageGroup, currentPoints: p.currentPoints }
                            : p
                    ));
                    showAlert('Състезателят е актуализиран успешно!');
                    setEditingPlayer(null);
                } else {
                    const newPlayer = {
                        id: generateId(),
                        ...playerForm,
                        ageGroup,
                        currentPoints: parseFloat(playerForm.initialPoints),
                        monthlyPoints: { [currentMonth]: parseFloat(playerForm.initialPoints) }
                    };
                    setPlayers([...players, newPlayer]);
                    showAlert('Състезателят е добавен успешно!');
                }
                
                setPlayerForm({
                    firstName: '', lastName: '', dateOfBirth: '', gender: 'Мъж',
                    clubId: '', licenseNumber: '', initialPoints: 500
                });
            };

            const editPlayer = (player) => {
                setPlayerForm({
                    firstName: player.firstName,
                    lastName: player.lastName,
                    dateOfBirth: player.dateOfBirth,
                    gender: player.gender,
                    clubId: player.clubId,
                    licenseNumber: player.licenseNumber,
                    initialPoints: player.initialPoints
                });
                setEditingPlayer(player);
                setActiveTab('players');
            };

            const deletePlayer = (id) => {
                if (window.confirm('Сигурни ли сте, че искате да изтриете този състезател?')) {
                    setPlayers(players.filter(p => p.id !== id));
                    showAlert('Състезателят е изтрит успешно!');
                }
            };

            // Club CRUD
            const addOrUpdateClub = () => {
                if (!clubForm.name || !clubForm.city) {
                    showAlert('Моля попълнете всички задължителни полета!', 'error');
                    return;
                }

                if (editingClub) {
                    setClubs(clubs.map(c => 
                        c.id === editingClub.id ? { ...c, ...clubForm } : c
                    ));
                    showAlert('Клубът е актуализиран успешно!');
                    setEditingClub(null);
                } else {
                    const newClub = { id: generateId(), ...clubForm };
                    setClubs([...clubs, newClub]);
                    showAlert('Клубът е добавен успешно!');
                }
                
                setClubForm({ name: '', city: '', clubNumber: '' });
            };

            const editClub = (club) => {
                setClubForm({
                    name: club.name,
                    city: club.city,
                    clubNumber: club.clubNumber
                });
                setEditingClub(club);
                setActiveTab('clubs');
            };

            const deleteClub = (id) => {
                if (window.confirm('Сигурни ли сте, че искате да изтриете този клуб?')) {
                    setClubs(clubs.filter(c => c.id !== id));
                    showAlert('Клубът е изтрит успешно!');
                }
            };

            // Tournament CRUD
            const addOrUpdateTournament = () => {
                if (!tournamentForm.name || !tournamentForm.startDate) {
                    showAlert('Моля попълнете всички задължителни полета!', 'error');
                    return;
                }

                if (editingTournament) {
                    setTournaments(tournaments.map(t => 
                        t.id === editingTournament.id ? { ...t, ...tournamentForm } : t
                    ));
                    showAlert('Турнирът е актуализиран успешно!');
                    setEditingTournament(null);
                } else {
                    const newTournament = { id: generateId(), ...tournamentForm };
                    setTournaments([...tournaments, newTournament]);
                    showAlert('Турнирът е добавен успешно!');
                }
                
                setTournamentForm({
                    name: '', startDate: '', endDate: '', location: '', hostClubId: '', coefficient: 1.0
                });
            };

            const editTournament = (tournament) => {
                setTournamentForm({
                    name: tournament.name,
                    startDate: tournament.startDate,
                    endDate: tournament.endDate,
                    location: tournament.location,
                    hostClubId: tournament.hostClubId,
                    coefficient: tournament.coefficient
                });
                setEditingTournament(tournament);
                setActiveTab('tournaments');
            };

            const deleteTournament = (id) => {
                if (window.confirm('Сигурни ли сте, че искате да изтриете този турнир?')) {
                    setTournaments(tournaments.filter(t => t.id !== id));
                    showAlert('Турнирът е изтрит успешно!');
                }
            };

            // Match handling
            const addMatch = () => {
                if (!matchForm.tournamentId || !matchForm.player1Id || !matchForm.player2Id || !matchForm.winnerId) {
                    showAlert('Моля попълнете всички задължителни полета!', 'error');
                    return;
                }

                if (matchForm.player1Id === matchForm.player2Id) {
                    showAlert('Не може да изберете един и същи играч!', 'error');
                    return;
                }

                const player1 = players.find(p => p.id === matchForm.player1Id);
                const player2 = players.find(p => p.id === matchForm.player2Id);
                const tournament = tournaments.find(t => t.id === matchForm.tournamentId);
                
                const winner = matchForm.winnerId === player1.id ? player1 : player2;
                const loser = matchForm.winnerId === player1.id ? player2 : player1;
                
                const isWinnerStronger = winner.currentPoints >= loser.currentPoints;
                const pointsChange = calculatePointsChange(
                    winner.currentPoints, 
                    loser.currentPoints, 
                    isWinnerStronger
                );
                
                // Apply tournament coefficient
                const coefficient = parseFloat(tournament.coefficient) || 1.0;
                const finalWinnerChange = pointsChange.winner * coefficient;
                const finalLoserChange = pointsChange.loser * coefficient;

                // Update player points
                setPlayers(players.map(p => {
                    if (p.id === winner.id) {
                        return {
                            ...p,
                            currentPoints: p.currentPoints + finalWinnerChange,
                            monthlyPoints: {
                                ...p.monthlyPoints,
                                [currentMonth]: (p.monthlyPoints?.[currentMonth] || p.currentPoints) + finalWinnerChange
                            }
                        };
                    }
                    if (p.id === loser.id) {
                        return {
                            ...p,
                            currentPoints: Math.max(0, p.currentPoints + finalLoserChange),
                            monthlyPoints: {
                                ...p.monthlyPoints,
                                [currentMonth]: Math.max(0, (p.monthlyPoints?.[currentMonth] || p.currentPoints) + finalLoserChange)
                            }
                        };
                    }
                    return p;
                }));

                const newMatch = {
                    id: generateId(),
                    ...matchForm,
                    date: new Date().toISOString(),
                    month: currentMonth,
                    pointsChange: {
                        [winner.id]: finalWinnerChange,
                        [loser.id]: finalLoserChange
                    }
                };

                setMatches([...matches, newMatch]);
                showAlert('Мачът е добавен успешно!');
                
                setMatchForm({
                    tournamentId: '', player1Id: '', player2Id: '', 
                    format: 'best-of-5', winnerId: '', score: ''
                });
                setSelectedPlayer1(null);
                setSelectedPlayer2(null);
                setPlayer1Search('');
                setPlayer2Search('');
            };

            const deleteMatch = (matchId) => {
                if (window.confirm('Сигурни ли сте, че искате да изтриете този мач? Точките ще бъдат възстановени.')) {
                    const match = matches.find(m => m.id === matchId);
                    
                    // Reverse points changes
                    setPlayers(players.map(p => {
                        if (match.pointsChange[p.id] !== undefined) {
                            return {
                                ...p,
                                currentPoints: p.currentPoints - match.pointsChange[p.id],
                                monthlyPoints: {
                                    ...p.monthlyPoints,
                                    [match.month]: (p.monthlyPoints?.[match.month] || p.currentPoints) - match.pointsChange[p.id]
                                }
                            };
                        }
                        return p;
                    }));

                    setMatches(matches.filter(m => m.id !== matchId));
                    showAlert('Мачът е изтрит успешно!');
                }
            };

            // Month navigation
            const changeMonth = (direction) => {
                const [year, month] = currentMonth.split('-').map(Number);
                const date = new Date(year, month - 1);
                date.setMonth(date.getMonth() + direction);
                setCurrentMonth(`${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`);
            };

            const startNewMonth = () => {
                if (window.confirm('Сигурни ли сте, че искате да стартирате нов месец? Текущите точки ще бъдат запазени в историята.')) {
                    const newMonth = getCurrentMonth();
                    
                    // Save current rankings
                    const currentRankings = {};
                    players.forEach(p => {
                        currentRankings[p.id] = p.currentPoints;
                    });
                    
                    setMonthlyRankings({
                        ...monthlyRankings,
                        [currentMonth]: currentRankings
                    });
                    
                    // Update players for new month
                    setPlayers(players.map(p => ({
                        ...p,
                        monthlyPoints: {
                            ...p.monthlyPoints,
                            [newMonth]: p.currentPoints
                        }
                    })));
                    
                    setCurrentMonth(newMonth);
                    showAlert('Новият месец е стартиран успешно!');
                }
            };

            // Filtered and sorted ranking
            const rankedPlayers = useMemo(() => {
                let filtered = [...players];
                
                // Apply filters
                if (searchTerm) {
                    filtered = filtered.filter(p => 
                        p.firstName.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        p.lastName.toLowerCase().includes(searchTerm.toLowerCase())
                    );
                }
                
                if (filterClub) {
                    filtered = filtered.filter(p => p.clubId === filterClub);
                }
                
                if (filterAgeGroup) {
                    filtered = filtered.filter(p => p.ageGroup === filterAgeGroup);
                }
                
                // Sort by points
                filtered.sort((a, b) => b.currentPoints - a.currentPoints);
                
                return filtered;
            }, [players, searchTerm, filterClub, filterAgeGroup]);

            // Get unique age groups
            const ageGroups = [...new Set(players.map(p => p.ageGroup))];

            // Player search functions
            const searchPlayers = (searchTerm) => {
                if (!searchTerm || searchTerm.length < 1) return [];
                
                const term = searchTerm.toLowerCase();
                return players.filter(p => {
                    const fullName = `${p.firstName} ${p.lastName}`.toLowerCase();
                    const license = p.licenseNumber?.toLowerCase() || '';
                    return fullName.includes(term) || license.includes(term);
                }).slice(0, 10); // Limit to 10 results
            };

            const selectPlayer1 = (player) => {
                setSelectedPlayer1(player);
                setMatchForm({...matchForm, player1Id: player.id, winnerId: ''});
                setPlayer1Search('');
                setShowPlayer1Dropdown(false);
            };

            const selectPlayer2 = (player) => {
                setSelectedPlayer2(player);
                setMatchForm({...matchForm, player2Id: player.id, winnerId: ''});
                setPlayer2Search('');
                setShowPlayer2Dropdown(false);
            };

            const clearPlayer1 = () => {
                setSelectedPlayer1(null);
                setMatchForm({...matchForm, player1Id: '', winnerId: ''});
                setPlayer1Search('');
            };

            const clearPlayer2 = () => {
                setSelectedPlayer2(null);
                setMatchForm({...matchForm, player2Id: '', winnerId: ''});
                setPlayer2Search('');
            };

            // Export functions
            const exportToJSON = () => {
                const data = {
                    players,
                    clubs,
                    tournaments,
                    matches,
                    monthlyRankings,
                    exportDate: new Date().toISOString()
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `tt-ranking-${currentMonth}.json`;
                a.click();
                showAlert('Данните са експортирани успешно!');
            };

            const exportToExcel = () => {
                // Create workbook
                let excelContent = `
                    <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
                    <head>
                        <meta charset="utf-8">
                        <!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets>
                `;
                
                // Ranking Sheet
                excelContent += `
                    <x:ExcelWorksheet><x:Name>Ранглиста</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet>
                `;
                
                // Players Sheet
                excelContent += `
                    <x:ExcelWorksheet><x:Name>Състезатели</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet>
                `;
                
                // Clubs Sheet
                excelContent += `
                    <x:ExcelWorksheet><x:Name>Клубове</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet>
                `;
                
                // Tournaments Sheet
                excelContent += `
                    <x:ExcelWorksheet><x:Name>Турнири</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet>
                `;
                
                // Matches Sheet
                excelContent += `
                    <x:ExcelWorksheet><x:Name>Мачове</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet>
                `;
                
                excelContent += `
                    </x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]-->
                    </head>
                    <body>
                `;
                
                // Ranking Table
                excelContent += `<table><tr><td colspan="7" style="font-size:16px;font-weight:bold;">Ранглиста за ${currentMonth}</td></tr>`;
                excelContent += `<tr style="font-weight:bold;background:#667eea;color:white;">
                    <td>Позиция</td><td>Име</td><td>Фамилия</td><td>Възрастова група</td><td>Клуб</td><td>Точки</td><td>Картотека №</td>
                </tr>`;
                rankedPlayers.forEach((player, index) => {
                    const club = clubs.find(c => c.id === player.clubId);
                    excelContent += `<tr>
                        <td>${index + 1}</td>
                        <td>${player.firstName}</td>
                        <td>${player.lastName}</td>
                        <td>${player.ageGroup}</td>
                        <td>${club ? club.name : '-'}</td>
                        <td>${player.currentPoints.toFixed(1)}</td>
                        <td>${player.licenseNumber || '-'}</td>
                    </tr>`;
                });
                excelContent += `</table><br><br>`;
                
                // Players Table
                excelContent += `<table><tr><td colspan="8" style="font-size:16px;font-weight:bold;">Състезатели</td></tr>`;
                excelContent += `<tr style="font-weight:bold;background:#667eea;color:white;">
                    <td>Име</td><td>Фамилия</td><td>Дата на раждане</td><td>Пол</td><td>Възрастова група</td><td>Клуб</td><td>Точки</td><td>Картотека №</td>
                </tr>`;
                players.forEach(player => {
                    const club = clubs.find(c => c.id === player.clubId);
                    excelContent += `<tr>
                        <td>${player.firstName}</td>
                        <td>${player.lastName}</td>
                        <td>${player.dateOfBirth}</td>
                        <td>${player.gender}</td>
                        <td>${player.ageGroup}</td>
                        <td>${club ? club.name : '-'}</td>
                        <td>${player.currentPoints.toFixed(1)}</td>
                        <td>${player.licenseNumber || '-'}</td>
                    </tr>`;
                });
                excelContent += `</table><br><br>`;
                
                // Clubs Table
                excelContent += `<table><tr><td colspan="3" style="font-size:16px;font-weight:bold;">Клубове</td></tr>`;
                excelContent += `<tr style="font-weight:bold;background:#667eea;color:white;">
                    <td>Име</td><td>Град</td><td>Номер на клуба</td>
                </tr>`;
                clubs.forEach(club => {
                    excelContent += `<tr>
                        <td>${club.name}</td>
                        <td>${club.city}</td>
                        <td>${club.clubNumber || '-'}</td>
                    </tr>`;
                });
                excelContent += `</table><br><br>`;
                
                // Tournaments Table
                excelContent += `<table><tr><td colspan="6" style="font-size:16px;font-weight:bold;">Турнири</td></tr>`;
                excelContent += `<tr style="font-weight:bold;background:#667eea;color:white;">
                    <td>Име</td><td>Начална дата</td><td>Крайна дата</td><td>Локация</td><td>Клуб домакин</td><td>Коефициент</td>
                </tr>`;
                tournaments.forEach(tournament => {
                    const hostClub = clubs.find(c => c.id === tournament.hostClubId);
                    excelContent += `<tr>
                        <td>${tournament.name}</td>
                        <td>${formatDateToDDMMYYYY(tournament.startDate)}</td>
                        <td>${formatDateToDDMMYYYY(tournament.endDate)}</td>
                        <td>${tournament.location || '-'}</td>
                        <td>${hostClub ? hostClub.name : '-'}</td>
                        <td>${tournament.coefficient}x</td>
                    </tr>`;
                });
                excelContent += `</table><br><br>`;
                
                // Matches Table
                excelContent += `<table><tr><td colspan="7" style="font-size:16px;font-weight:bold;">Мачове</td></tr>`;
                excelContent += `<tr style="font-weight:bold;background:#667eea;color:white;">
                    <td>Дата</td><td>Турнир</td><td>Играч 1</td><td>Играч 2</td><td>Победител</td><td>Резултат</td><td>Формат</td>
                </tr>`;
                matches.forEach(match => {
                    const tournament = tournaments.find(t => t.id === match.tournamentId);
                    const player1 = players.find(p => p.id === match.player1Id);
                    const player2 = players.find(p => p.id === match.player2Id);
                    const winner = players.find(p => p.id === match.winnerId);
                    excelContent += `<tr>
                        <td>${new Date(match.date).toLocaleDateString('bg-BG')}</td>
                        <td>${tournament?.name || '-'}</td>
                        <td>${player1 ? player1.firstName + ' ' + player1.lastName : '-'}</td>
                        <td>${player2 ? player2.firstName + ' ' + player2.lastName : '-'}</td>
                        <td>${winner ? winner.firstName + ' ' + winner.lastName : '-'}</td>
                        <td>${match.score || '-'}</td>
                        <td>${match.format === 'best-of-5' ? 'Best of 5' : 'Best of 7'}</td>
                    </tr>`;
                });
                excelContent += `</table>`;
                
                excelContent += `</body></html>`;
                
                const blob = new Blob([excelContent], { type: 'application/vnd.ms-excel' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `tt-ranking-${currentMonth}.xls`;
                a.click();
                showAlert('Excel файлът е експортиран успешно!');
            };

            const exportToPDF = () => {
                let pdfContent = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="utf-8">
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            h1 { color: #667eea; text-align: center; }
                            h2 { color: #764ba2; margin-top: 30px; border-bottom: 2px solid #667eea; padding-bottom: 5px; }
                            table { width: 100%; border-collapse: collapse; margin-bottom: 30px; page-break-inside: auto; }
                            tr { page-break-inside: avoid; page-break-after: auto; }
                            th { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 10px; text-align: left; font-weight: bold; }
                            td { padding: 8px; border-bottom: 1px solid #e0e0e0; }
                            tr:nth-child(even) { background: #f8f9fa; }
                            .ranking-1 { color: #FFD700; font-weight: bold; }
                            .ranking-2 { color: #C0C0C0; font-weight: bold; }
                            .ranking-3 { color: #CD7F32; font-weight: bold; }
                            .page-break { page-break-before: always; }
                        </style>
                    </head>
                    <body>
                        <h1>🏓 Ранглиста Тенис на Маса</h1>
                        <p style="text-align:center;">Експорт от ${new Date().toLocaleDateString('bg-BG')}</p>
                `;
                
                // Ranking
                pdfContent += `<h2>Ранглиста за ${currentMonth}</h2>`;
                pdfContent += `<table><thead><tr>
                    <th>Позиция</th><th>Име</th><th>Фамилия</th><th>Възрастова група</th><th>Клуб</th><th>Точки</th><th>Картотека №</th>
                </tr></thead><tbody>`;
                rankedPlayers.forEach((player, index) => {
                    const club = clubs.find(c => c.id === player.clubId);
                    let posClass = '';
                    if (index === 0) posClass = 'ranking-1';
                    else if (index === 1) posClass = 'ranking-2';
                    else if (index === 2) posClass = 'ranking-3';
                    pdfContent += `<tr>
                        <td class="${posClass}">#${index + 1}</td>
                        <td>${player.firstName}</td>
                        <td>${player.lastName}</td>
                        <td>${player.ageGroup}</td>
                        <td>${club ? club.name : '-'}</td>
                        <td><strong>${player.currentPoints.toFixed(1)}</strong></td>
                        <td>${player.licenseNumber || '-'}</td>
                    </tr>`;
                });
                pdfContent += `</tbody></table>`;
                
                // Players
                pdfContent += `<div class="page-break"></div>`;
                pdfContent += `<h2>Състезатели (${players.length})</h2>`;
                pdfContent += `<table><thead><tr>
                    <th>Име</th><th>Фамилия</th><th>Пол</th><th>Възрастова група</th><th>Клуб</th><th>Точки</th><th>Картотека №</th>
                </tr></thead><tbody>`;
                players.forEach(player => {
                    const club = clubs.find(c => c.id === player.clubId);
                    pdfContent += `<tr>
                        <td>${player.firstName}</td>
                        <td>${player.lastName}</td>
                        <td>${player.gender}</td>
                        <td>${player.ageGroup}</td>
                        <td>${club ? club.name : '-'}</td>
                        <td>${player.currentPoints.toFixed(1)}</td>
                        <td>${player.licenseNumber || '-'}</td>
                    </tr>`;
                });
                pdfContent += `</tbody></table>`;
                
                // Clubs
                pdfContent += `<h2>Клубове (${clubs.length})</h2>`;
                pdfContent += `<table><thead><tr>
                    <th>Име на клуба</th><th>Град</th><th>Номер на клуба</th><th>Брой състезатели</th>
                </tr></thead><tbody>`;
                clubs.forEach(club => {
                    const playerCount = players.filter(p => p.clubId === club.id).length;
                    pdfContent += `<tr>
                        <td>${club.name}</td>
                        <td>${club.city}</td>
                        <td>${club.clubNumber || '-'}</td>
                        <td>${playerCount}</td>
                    </tr>`;
                });
                pdfContent += `</tbody></table>`;
                
                // Tournaments
                pdfContent += `<div class="page-break"></div>`;
                pdfContent += `<h2>Турнири (${tournaments.length})</h2>`;
                pdfContent += `<table><thead><tr>
                    <th>Име</th><th>Начална дата</th><th>Крайна дата</th><th>Локация</th><th>Клуб домакин</th><th>Коефициент</th><th>Мачове</th>
                </tr></thead><tbody>`;
                tournaments.forEach(tournament => {
                    const hostClub = clubs.find(c => c.id === tournament.hostClubId);
                    const matchCount = matches.filter(m => m.tournamentId === tournament.id).length;
                    pdfContent += `<tr>
                        <td>${tournament.name}</td>
                        <td>${formatDateToDDMMYYYY(tournament.startDate)}</td>
                        <td>${formatDateToDDMMYYYY(tournament.endDate)}</td>
                        <td>${tournament.location || '-'}</td>
                        <td>${hostClub ? hostClub.name : '-'}</td>
                        <td>${tournament.coefficient}x</td>
                        <td>${matchCount}</td>
                    </tr>`;
                });
                pdfContent += `</tbody></table>`;
                
                // Matches
                pdfContent += `<div class="page-break"></div>`;
                pdfContent += `<h2>Мачове (${matches.length})</h2>`;
                pdfContent += `<table><thead><tr>
                    <th>Дата</th><th>Турнир</th><th>Играч 1</th><th>Играч 2</th><th>Победител</th><th>Резултат</th>
                </tr></thead><tbody>`;
                matches.forEach(match => {
                    const tournament = tournaments.find(t => t.id === match.tournamentId);
                    const player1 = players.find(p => p.id === match.player1Id);
                    const player2 = players.find(p => p.id === match.player2Id);
                    const winner = players.find(p => p.id === match.winnerId);
                    pdfContent += `<tr>
                        <td>${new Date(match.date).toLocaleDateString('bg-BG')}</td>
                        <td>${tournament?.name || '-'}</td>
                        <td>${player1 ? player1.firstName + ' ' + player1.lastName : '-'}</td>
                        <td>${player2 ? player2.firstName + ' ' + player2.lastName : '-'}</td>
                        <td><strong>${winner ? winner.firstName + ' ' + winner.lastName : '-'}</strong></td>
                        <td>${match.score || '-'}</td>
                    </tr>`;
                });
                pdfContent += `</tbody></table>`;
                
                pdfContent += `</body></html>`;
                
                // Open in new window for printing to PDF
                const printWindow = window.open('', '_blank');
                printWindow.document.write(pdfContent);
                printWindow.document.close();
                setTimeout(() => {
                    printWindow.print();
                }, 500);
                showAlert('PDF прозорецът е отворен. Изберете "Запази като PDF" в диалога за печат.');
            };

            const importFromJSON = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            if (window.confirm('Сигурни ли сте, че искате да импортирате данни? Това ще замени текущите данни.')) {
                                setPlayers(data.players || []);
                                setClubs(data.clubs || []);
                                setTournaments(data.tournaments || []);
                                setMatches(data.matches || []);
                                setMonthlyRankings(data.monthlyRankings || {});
                                showAlert('Данните са импортирани успешно!');
                            }
                        } catch (error) {
                            showAlert('Грешка при импортиране на данни!', 'error');
                        }
                    };
                    reader.readAsText(file);
                }
            };

            return (
                <div className="container">
                    {showLogin && (
                        <div className="login-overlay">
                            <div className="login-modal">
                                <h2>🔐 Вход в системата</h2>
                                <p>Моля, въведете вашите данни за вход като администратор</p>
                                <div className="form-group">
                                    <label>Потребителско име</label>
                                    <input
                                        type="text"
                                        value={loginForm.username}
                                        onChange={(e) => setLoginForm({...loginForm, username: e.target.value})}
                                        placeholder="admin"
                                        onKeyPress={(e) => e.key === 'Enter' && handleLogin()}
                                    />
                                </div>
                                <div className="form-group">
                                    <label>Парола</label>
                                    <input
                                        type="password"
                                        value={loginForm.password}
                                        onChange={(e) => setLoginForm({...loginForm, password: e.target.value})}
                                        placeholder="••••••••"
                                        onKeyPress={(e) => e.key === 'Enter' && handleLogin()}
                                    />
                                </div>
                                <div className="login-buttons">
                                    <button className="btn btn-primary" onClick={handleLogin}>
                                        Вход като администратор
                                    </button>
                                    <button className="btn btn-secondary" onClick={enterAsGuest}>
                                        Продължи като гост
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="header header-container">
                        <h1>🏓 Ранглиста Тенис на Маса</h1>
                        <p>Система за управление на ранглиста и турнири</p>
                        <div className="header-actions">
                            {!isAuthenticated ? (
                                <button className="btn btn-primary" onClick={() => setShowLogin(true)}>
                                    Вход
                                </button>
                            ) : (
                                <>
                                    {isAdmin ? (
                                        <>
                                            <span className="welcome-text">Администратор</span>
                                            <span className="admin-badge">ADMIN</span>
                                            <button className="btn btn-secondary" onClick={handleLogout}>
                                                Изход
                                            </button>
                                        </>
                                    ) : (
                                        <>
                                            <span className="welcome-text">Гост режим</span>
                                            <span className="guest-badge">ГОСТ</span>
                                            <button className="btn btn-primary" onClick={() => setShowLogin(true)}>
                                                Вход като админ
                                            </button>
                                        </>
                                    )}
                                </>
                            )}
                        </div>
                    </div>

                    {alert && (
                        <div className={`alert ${alert.type === 'success' ? 'alert-success' : 'alert-error'}`}>
                            {alert.message}
                        </div>
                    )}

                    <div className="nav-tabs">
                        <button className={`nav-tab ${activeTab === 'ranking' ? 'active' : ''}`} 
                                onClick={() => setActiveTab('ranking')}>
                            Ранглиста
                        </button>
                        <button className={`nav-tab ${activeTab === 'players' ? 'active' : ''}`} 
                                onClick={() => setActiveTab('players')}>
                            Състезатели
                        </button>
                        {isAdmin && (
                            <button className={`nav-tab ${activeTab === 'clubs' ? 'active' : ''}`} 
                                    onClick={() => setActiveTab('clubs')}>
                                Клубове
                            </button>
                        )}
                        <button className={`nav-tab ${activeTab === 'tournaments' ? 'active' : ''}`} 
                                onClick={() => setActiveTab('tournaments')}>
                            Турнири
                        </button>
                        <button className={`nav-tab ${activeTab === 'matches' ? 'active' : ''}`} 
                                onClick={() => setActiveTab('matches')}>
                            Мачове
                        </button>
                        <button className={`nav-tab ${activeTab === 'history' ? 'active' : ''}`} 
                                onClick={() => setActiveTab('history')}>
                            История
                        </button>
                    </div>

                    <div className="content">
                        {activeTab === 'ranking' && (
                            <div>
                                {isAdmin && (
                                    <div className="month-selector">
                                        <button className="btn btn-secondary" onClick={() => changeMonth(-1)}>
                                            ← Предишен месец
                                        </button>
                                        <h2 style={{flex: 1, textAlign: 'center'}}>
                                            Ранглиста за {currentMonth}
                                        </h2>
                                        <button className="btn btn-secondary" onClick={() => changeMonth(1)}>
                                            Следващ месец →
                                        </button>
                                        <button className="btn btn-success" onClick={startNewMonth}>
                                            Стартирай нов месец
                                        </button>
                                    </div>
                                )}
                                
                                {!isAdmin && (
                                    <div style={{textAlign: 'center', marginBottom: '20px'}}>
                                        <h2>Ранглиста за {currentMonth}</h2>
                                    </div>
                                )}

                                <div className="stats-grid">
                                    <div className="stat-card">
                                        <h4>Общо състезатели</h4>
                                        <p>{players.length}</p>
                                    </div>
                                    <div className="stat-card">
                                        <h4>Общо клубове</h4>
                                        <p>{clubs.length}</p>
                                    </div>
                                    <div className="stat-card">
                                        <h4>Общо турнири</h4>
                                        <p>{tournaments.length}</p>
                                    </div>
                                    <div className="stat-card">
                                        <h4>Общо мачове</h4>
                                        <p>{matches.length}</p>
                                    </div>
                                </div>

                                <div className="search-filter">
                                    <div className="form-group">
                                        <label>Търсене по име</label>
                                        <input
                                            type="text"
                                            placeholder="Въведете име или фамилия..."
                                            value={searchTerm}
                                            onChange={(e) => setSearchTerm(e.target.value)}
                                        />
                                    </div>
                                    <div className="form-group">
                                        <label>Филтър по клуб</label>
                                        <select value={filterClub} onChange={(e) => setFilterClub(e.target.value)}>
                                            <option value="">Всички клубове</option>
                                            {clubs.map(club => (
                                                <option key={club.id} value={club.id}>{club.name}</option>
                                            ))}
                                        </select>
                                    </div>
                                    <div className="form-group">
                                        <label>Филтър по възрастова група</label>
                                        <select value={filterAgeGroup} onChange={(e) => setFilterAgeGroup(e.target.value)}>
                                            <option value="">Всички групи</option>
                                            {ageGroups.map(group => (
                                                <option key={group} value={group}>{group}</option>
                                            ))}
                                        </select>
                                    </div>
                                    <div className="form-group">
                                        <label>&nbsp;</label>
                                        <button className="btn btn-secondary" onClick={() => {
                                            setSearchTerm('');
                                            setFilterClub('');
                                            setFilterAgeGroup('');
                                        }}>
                                            Изчисти филтрите
                                        </button>
                                    </div>
                                </div>

                                <div className="table-container">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Позиция</th>
                                                <th>Име</th>
                                                <th>Фамилия</th>
                                                <th>Възрастова група</th>
                                                <th>Клуб</th>
                                                <th>Точки</th>
                                                <th>Картотека №</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {rankedPlayers.map((player, index) => {
                                                const club = clubs.find(c => c.id === player.clubId);
                                                let positionClass = 'ranking-position';
                                                if (index === 0) positionClass += ' ranking-gold';
                                                else if (index === 1) positionClass += ' ranking-silver';
                                                else if (index === 2) positionClass += ' ranking-bronze';
                                                
                                                return (
                                                    <tr key={player.id}>
                                                        <td className={positionClass}>#{index + 1}</td>
                                                        <td>{player.firstName}</td>
                                                        <td>{player.lastName}</td>
                                                        <td>{player.ageGroup}</td>
                                                        <td>{club ? club.name : '-'}</td>
                                                        <td><strong>{player.currentPoints.toFixed(1)}</strong></td>
                                                        <td>{player.licenseNumber || '-'}</td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>

                                {isAdmin && (
                                    <div className="export-section">
                                        <h3>Експорт / Импорт</h3>
                                        <div style={{marginBottom: '15px'}}>
                                            <button className="btn btn-primary" onClick={exportToExcel}>
                                                📊 Експорт в Excel
                                            </button>
                                            <button className="btn btn-primary" onClick={exportToPDF}>
                                                📄 Експорт в PDF
                                            </button>
                                            <button className="btn btn-secondary" onClick={exportToJSON}>
                                                💾 Експорт в JSON
                                            </button>
                                        </div>
                                        <div>
                                            <label className="btn btn-secondary" style={{display: 'inline-block', cursor: 'pointer'}}>
                                                📥 Импорт от JSON
                                                <input type="file" accept=".json" onChange={importFromJSON} style={{display: 'none'}} />
                                            </label>
                                        </div>
                                        <button className="btn btn-success" onClick={() => {
                                            const autoBackup = localStorage.getItem('tt_auto_backup');
                                            const backupTimestamp = localStorage.getItem('tt_backup_timestamp');
                                            
                                            if (autoBackup) {
                                                const backup = JSON.parse(autoBackup);
                                                const backupDate = backupTimestamp ? new Date(backupTimestamp).toLocaleString('bg-BG') : 'неизвестна дата';
                                                
                                                if (window.confirm(`Ще възстановите данните от автоматичния backup (${backupDate}).\n\nТова ще презапише текущите данни!\n\nПродължете?`)) {
                                                    setPlayers(backup.players || []);
                                                    setClubs(backup.clubs || []);
                                                    setTournaments(backup.tournaments || []);
                                                    setMatches(backup.matches || []);
                                                    setMonthlyRankings(backup.monthlyRankings || {});
                                                    showAlert('Данните са възстановени от backup!');
                                                }
                                            } else {
                                                showAlert('Няма намерен автоматичен backup!', 'error');
                                            }
                                        }}>
                                            🔄 Възстанови от Backup
                                        </button>
                                    </div>
                                )}
                            </div>
                        )}

                        {activeTab === 'players' && (
                            <div>
                                {isAdmin && (
                                    <div className="card">
                                        <h3>{editingPlayer ? 'Редактиране на състезател' : 'Добавяне на нов състезател'}</h3>
                                        <div className="form-row">
                                            <div className="form-group">
                                                <label>Име *</label>
                                                <input
                                                    type="text"
                                                    value={playerForm.firstName}
                                                    onChange={(e) => setPlayerForm({...playerForm, firstName: e.target.value})}
                                                    placeholder="Въведете име"
                                                />
                                            </div>
                                            <div className="form-group">
                                                <label>Фамилия *</label>
                                                <input
                                                    type="text"
                                                    value={playerForm.lastName}
                                                    onChange={(e) => setPlayerForm({...playerForm, lastName: e.target.value})}
                                                    placeholder="Въведете фамилия"
                                                />
                                            </div>
                                            <div className="form-group">
                                                <label>Дата на раждане *</label>
                                                <input
                                                    type="date"
                                                    value={playerForm.dateOfBirth}
                                                    onChange={(e) => setPlayerForm({...playerForm, dateOfBirth: e.target.value})}
                                                />
                                            </div>
                                        </div>
                                        <div className="form-row">
                                            <div className="form-group">
                                                <label>Пол</label>
                                                <select
                                                    value={playerForm.gender}
                                                    onChange={(e) => setPlayerForm({...playerForm, gender: e.target.value})}
                                                >
                                                    <option value="Мъж">Мъж</option>
                                                    <option value="Жена">Жена</option>
                                                </select>
                                            </div>
                                            <div className="form-group">
                                                <label>Възрастова група</label>
                                                <input
                                                    type="text"
                                                    value={playerForm.dateOfBirth && playerForm.gender ? getAgeGroup(playerForm.dateOfBirth, playerForm.gender) : ''}
                                                    disabled
                                                    style={{background: '#f0f0f0', cursor: 'not-allowed'}}
                                                    placeholder="Автоматично след въвеждане на дата"
                                                />
                                            </div>
                                        </div>
                                        <div className="form-row">
                                            <div className="form-group">
                                                <label>Клуб</label>
                                                <select
                                                    value={playerForm.clubId}
                                                    onChange={(e) => setPlayerForm({...playerForm, clubId: e.target.value})}
                                                >
                                                    <option value="">Изберете клуб</option>
                                                    {clubs.map(club => (
                                                        <option key={club.id} value={club.id}>{club.name}</option>
                                                    ))}
                                                </select>
                                            </div>
                                            <div className="form-group">
                                                <label>Картотека №</label>
                                                <input
                                                    type="text"
                                                    value={playerForm.licenseNumber}
                                                    onChange={(e) => setPlayerForm({...playerForm, licenseNumber: e.target.value})}
                                                    placeholder="Номер на картотека"
                                                />
                                            </div>
                                            <div className="form-group">
                                                <label>Начални точки</label>
                                                <input
                                                    type="number"
                                                    value={playerForm.initialPoints}
                                                    onChange={(e) => setPlayerForm({...playerForm, initialPoints: e.target.value})}
                                                    placeholder="500"
                                                />
                                            </div>
                                        </div>
                                        <button className="btn btn-primary" onClick={addOrUpdatePlayer}>
                                            {editingPlayer ? 'Актуализирай състезател' : 'Добави състезател'}
                                        </button>
                                        {editingPlayer && (
                                            <button className="btn btn-secondary" onClick={() => {
                                                setEditingPlayer(null);
                                                setPlayerForm({
                                                    firstName: '', lastName: '', dateOfBirth: '', gender: 'Мъж',
                                                    clubId: '', licenseNumber: '', initialPoints: 500
                                                });
                                            }}>
                                                Откажи
                                            </button>
                                        )}
                                    </div>
                                )}

                                <div className="card">
                                    <h3>Списък на състезателите</h3>
                                    <div className="table-container">
                                        <table>
                                            <thead>
                                                <tr>
                                                    <th>Име</th>
                                                    <th>Фамилия</th>
                                                    <th>Пол</th>
                                                    <th>Възрастова група</th>
                                                    <th>Клуб</th>
                                                    <th>Точки</th>
                                                    <th>Картотека №</th>
                                                    {isAdmin && <th>Действия</th>}
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {players.map(player => {
                                                    const club = clubs.find(c => c.id === player.clubId);
                                                    return (
                                                        <tr key={player.id}>
                                                            <td>{player.firstName}</td>
                                                            <td>{player.lastName}</td>
                                                            <td>{player.gender}</td>
                                                            <td>{player.ageGroup}</td>
                                                            <td>{club ? club.name : '-'}</td>
                                                            <td>{player.currentPoints.toFixed(1)}</td>
                                                            <td>{player.licenseNumber || '-'}</td>
                                                            {isAdmin && (
                                                                <td>
                                                                    <div className="action-buttons">
                                                                        <button className="btn btn-sm btn-primary" onClick={() => editPlayer(player)}>
                                                                            Редактирай
                                                                        </button>
                                                                        <button className="btn btn-sm btn-danger" onClick={() => deletePlayer(player.id)}>
                                                                            Изтрий
                                                                        </button>
                                                                    </div>
                                                                </td>
                                                            )}
                                                        </tr>
                                                    );
                                                })}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'clubs' && (
                            <div>
                                <div className="card">
                                    <h3>{editingClub ? 'Редактиране на клуб' : 'Добавяне на нов клуб'}</h3>
                                    <div className="form-row">
                                        <div className="form-group">
                                            <label>Име на клуба *</label>
                                            <input
                                                type="text"
                                                value={clubForm.name}
                                                onChange={(e) => setClubForm({...clubForm, name: e.target.value})}
                                                placeholder="Въведете име на клуба"
                                            />
                                        </div>
                                        <div className="form-group">
                                            <label>Град *</label>
                                            <input
                                                type="text"
                                                value={clubForm.city}
                                                onChange={(e) => setClubForm({...clubForm, city: e.target.value})}
                                                placeholder="Въведете град"
                                            />
                                        </div>
                                        <div className="form-group">
                                            <label>Номер на клуба</label>
                                            <input
                                                type="text"
                                                value={clubForm.clubNumber}
                                                onChange={(e) => setClubForm({...clubForm, clubNumber: e.target.value})}
                                                placeholder="Номер на картотека"
                                            />
                                        </div>
                                    </div>
                                    <button className="btn btn-primary" onClick={addOrUpdateClub}>
                                        {editingClub ? 'Актуализирай клуб' : 'Добави клуб'}
                                    </button>
                                    {editingClub && (
                                        <button className="btn btn-secondary" onClick={() => {
                                            setEditingClub(null);
                                            setClubForm({ name: '', city: '', clubNumber: '' });
                                        }}>
                                            Откажи
                                        </button>
                                    )}
                                </div>

                                <div className="card">
                                    <h3>Списък на клубовете</h3>
                                    <div className="table-container">
                                        <table>
                                            <thead>
                                                <tr>
                                                    <th>Име на клуба</th>
                                                    <th>Град</th>
                                                    <th>Номер на клуба</th>
                                                    <th>Брой състезатели</th>
                                                    <th>Действия</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {clubs.map(club => {
                                                    const playerCount = players.filter(p => p.clubId === club.id).length;
                                                    return (
                                                        <tr key={club.id}>
                                                            <td>{club.name}</td>
                                                            <td>{club.city}</td>
                                                            <td>{club.clubNumber || '-'}</td>
                                                            <td>{playerCount}</td>
                                                            <td>
                                                                <div className="action-buttons">
                                                                    <button className="btn btn-sm btn-primary" onClick={() => editClub(club)}>
                                                                        Редактирай
                                                                    </button>
                                                                    <button className="btn btn-sm btn-danger" onClick={() => deleteClub(club.id)}>
                                                                        Изтрий
                                                                    </button>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    );
                                                })}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'tournaments' && (
                            <div>
                                {isAdmin && (
                                    <div className="card">
                                        <h3>{editingTournament ? 'Редактиране на турнир' : 'Добавяне на нов турнир'}</h3>
                                        <div className="form-row">
                                            <div className="form-group">
                                                <label>Име на турнира *</label>
                                                <input
                                                    type="text"
                                                    value={tournamentForm.name}
                                                    onChange={(e) => setTournamentForm({...tournamentForm, name: e.target.value})}
                                                    placeholder="Въведете име на турнира"
                                                />
                                            </div>
                                            <div className="form-group">
                                                <label>Начална дата *</label>
                                                <input
                                                    type="date"
                                                    value={tournamentForm.startDate}
                                                    onChange={(e) => setTournamentForm({...tournamentForm, startDate: e.target.value})}
                                                />
                                            </div>
                                            <div className="form-group">
                                                <label>Крайна дата</label>
                                                <input
                                                    type="date"
                                                    value={tournamentForm.endDate}
                                                    onChange={(e) => setTournamentForm({...tournamentForm, endDate: e.target.value})}
                                                />
                                            </div>
                                        </div>
                                        <div className="form-row">
                                            <div className="form-group">
                                                <label>Локация</label>
                                                <input
                                                    type="text"
                                                    value={tournamentForm.location}
                                                    onChange={(e) => setTournamentForm({...tournamentForm, location: e.target.value})}
                                                    placeholder="Град или адрес"
                                                />
                                            </div>
                                            <div className="form-group">
                                                <label>Клуб домакин</label>
                                                <select
                                                    value={tournamentForm.hostClubId}
                                                    onChange={(e) => setTournamentForm({...tournamentForm, hostClubId: e.target.value})}
                                                >
                                                    <option value="">Изберете клуб</option>
                                                    {clubs.map(club => (
                                                        <option key={club.id} value={club.id}>{club.name}</option>
                                                    ))}
                                                </select>
                                            </div>
                                            <div className="form-group">
                                                <label>Коефициент (0.5, 0.75, 1.0)</label>
                                                <input
                                                    type="number"
                                                    step="0.25"
                                                    min="0.5"
                                                    max="1.0"
                                                    value={tournamentForm.coefficient}
                                                    onChange={(e) => setTournamentForm({...tournamentForm, coefficient: e.target.value})}
                                                />
                                            </div>
                                        </div>
                                        <button className="btn btn-primary" onClick={addOrUpdateTournament}>
                                            {editingTournament ? 'Актуализирай турнир' : 'Добави турнир'}
                                        </button>
                                        {editingTournament && (
                                            <button className="btn btn-secondary" onClick={() => {
                                                setEditingTournament(null);
                                                setTournamentForm({
                                                    name: '', startDate: '', endDate: '', location: '', hostClubId: '', coefficient: 1.0
                                                });
                                            }}>
                                                Откажи
                                            </button>
                                        )}
                                    </div>
                                )}

                                <div className="card">
                                    <h3>Списък на турнирите</h3>
                                    <div className="table-container">
                                        <table>
                                            <thead>
                                                <tr>
                                                    <th>Име</th>
                                                    <th>Начална дата</th>
                                                    <th>Крайна дата</th>
                                                    <th>Локация</th>
                                                    <th>Клуб домакин</th>
                                                    <th>Коефициент</th>
                                                    <th>Мачове</th>
                                                    {isAdmin && <th>Действия</th>}
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {tournaments.map(tournament => {
                                                    const hostClub = clubs.find(c => c.id === tournament.hostClubId);
                                                    const matchCount = matches.filter(m => m.tournamentId === tournament.id).length;
                                                    return (
                                                        <tr key={tournament.id}>
                                                            <td>{tournament.name}</td>
                                                            <td>{formatDateToDDMMYYYY(tournament.startDate)}</td>
                                                            <td>{formatDateToDDMMYYYY(tournament.endDate)}</td>
                                                            <td>{tournament.location || '-'}</td>
                                                            <td>{hostClub ? hostClub.name : '-'}</td>
                                                            <td>{tournament.coefficient}x</td>
                                                            <td>{matchCount}</td>
                                                            {isAdmin && (
                                                                <td>
                                                                    <div className="action-buttons">
                                                                        <button className="btn btn-sm btn-primary" onClick={() => editTournament(tournament)}>
                                                                            Редактирай
                                                                        </button>
                                                                        <button className="btn btn-sm btn-danger" onClick={() => deleteTournament(tournament.id)}>
                                                                            Изтрий
                                                                        </button>
                                                                    </div>
                                                                </td>
                                                            )}
                                                        </tr>
                                                    );
                                                })}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'matches' && (
                            <div>
                                {isAdmin && (
                                    <div className="card">
                                        <h3>Добавяне на нов мач</h3>
                                        <div className="form-row">
                                            <div className="form-group">
                                                <label>Турнир *</label>
                                                <select
                                                    value={matchForm.tournamentId}
                                                    onChange={(e) => setMatchForm({...matchForm, tournamentId: e.target.value})}
                                                >
                                                    <option value="">Изберете турнир</option>
                                                    {tournaments.map(tournament => (
                                                        <option key={tournament.id} value={tournament.id}>{tournament.name}</option>
                                                    ))}
                                                </select>
                                            </div>
                                            <div className="form-group">
                                                <label>Формат</label>
                                                <select
                                                    value={matchForm.format}
                                                    onChange={(e) => setMatchForm({...matchForm, format: e.target.value})}
                                                >
                                                    <option value="best-of-5">Best of 5 (3 от 5)</option>
                                                    <option value="best-of-7">Best of 7 (4 от 7)</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div className="form-row">
                                            <div className="form-group">
                                                <label>Играч 1 *</label>
                                                {!selectedPlayer1 ? (
                                                    <div className="autocomplete-container">
                                                        <input
                                                            type="text"
                                                            className="autocomplete-input"
                                                            value={player1Search}
                                                            onChange={(e) => {
                                                                setPlayer1Search(e.target.value);
                                                                setShowPlayer1Dropdown(true);
                                                            }}
                                                            onFocus={() => setShowPlayer1Dropdown(true)}
                                                            placeholder="Търси по име или номер на картотека..."
                                                        />
                                                        {showPlayer1Dropdown && player1Search && (
                                                            <div className="autocomplete-dropdown">
                                                                {searchPlayers(player1Search).length > 0 ? (
                                                                    searchPlayers(player1Search).map(player => (
                                                                        <div
                                                                            key={player.id}
                                                                            className="autocomplete-item"
                                                                            onClick={() => selectPlayer1(player)}
                                                                        >
                                                                            <div className="player-search-info">
                                                                                <div>
                                                                                    <div className="player-name">
                                                                                        {player.firstName} {player.lastName}
                                                                                    </div>
                                                                                    <div className="player-details">
                                                                                        <span className="player-license">#{player.licenseNumber || 'N/A'}</span>
                                                                                        {' • '}
                                                                                        <span className="player-points">{player.currentPoints.toFixed(1)} т.</span>
                                                                                        {' • '}
                                                                                        {player.ageGroup}
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    ))
                                                                ) : (
                                                                    <div className="autocomplete-item" style={{color: '#999'}}>
                                                                        Няма намерени играчи
                                                                    </div>
                                                                )}
                                                            </div>
                                                        )}
                                                    </div>
                                                ) : (
                                                    <div>
                                                        <div className="selected-player-badge">
                                                            {selectedPlayer1.firstName} {selectedPlayer1.lastName} 
                                                            {' '}(#{selectedPlayer1.licenseNumber || 'N/A'} • {selectedPlayer1.currentPoints.toFixed(1)} т.)
                                                            <button 
                                                                onClick={clearPlayer1}
                                                                style={{
                                                                    marginLeft: '10px',
                                                                    background: 'rgba(255,255,255,0.3)',
                                                                    border: 'none',
                                                                    color: 'white',
                                                                    borderRadius: '50%',
                                                                    width: '20px',
                                                                    height: '20px',
                                                                    cursor: 'pointer',
                                                                    fontSize: '12px'
                                                                }}
                                                            >×</button>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                            <div className="form-group">
                                                <label>Играч 2 *</label>
                                                {!selectedPlayer2 ? (
                                                    <div className="autocomplete-container">
                                                        <input
                                                            type="text"
                                                            className="autocomplete-input"
                                                            value={player2Search}
                                                            onChange={(e) => {
                                                                setPlayer2Search(e.target.value);
                                                                setShowPlayer2Dropdown(true);
                                                            }}
                                                            onFocus={() => setShowPlayer2Dropdown(true)}
                                                            placeholder="Търси по име или номер на картотека..."
                                                        />
                                                        {showPlayer2Dropdown && player2Search && (
                                                            <div className="autocomplete-dropdown">
                                                                {searchPlayers(player2Search).length > 0 ? (
                                                                    searchPlayers(player2Search).map(player => (
                                                                        <div
                                                                            key={player.id}
                                                                            className="autocomplete-item"
                                                                            onClick={() => selectPlayer2(player)}
                                                                        >
                                                                            <div className="player-search-info">
                                                                                <div>
                                                                                    <div className="player-name">
                                                                                        {player.firstName} {player.lastName}
                                                                                    </div>
                                                                                    <div className="player-details">
                                                                                        <span className="player-license">#{player.licenseNumber || 'N/A'}</span>
                                                                                        {' • '}
                                                                                        <span className="player-points">{player.currentPoints.toFixed(1)} т.</span>
                                                                                        {' • '}
                                                                                        {player.ageGroup}
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    ))
                                                                ) : (
                                                                    <div className="autocomplete-item" style={{color: '#999'}}>
                                                                        Няма намерени играчи
                                                                    </div>
                                                                )}
                                                            </div>
                                                        )}
                                                    </div>
                                                ) : (
                                                    <div>
                                                        <div className="selected-player-badge">
                                                            {selectedPlayer2.firstName} {selectedPlayer2.lastName}
                                                            {' '}(#{selectedPlayer2.licenseNumber || 'N/A'} • {selectedPlayer2.currentPoints.toFixed(1)} т.)
                                                            <button 
                                                                onClick={clearPlayer2}
                                                                style={{
                                                                    marginLeft: '10px',
                                                                    background: 'rgba(255,255,255,0.3)',
                                                                    border: 'none',
                                                                    color: 'white',
                                                                    borderRadius: '50%',
                                                                    width: '20px',
                                                                    height: '20px',
                                                                    cursor: 'pointer',
                                                                    fontSize: '12px'
                                                                }}
                                                            >×</button>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                        <div className="form-row">
                                            <div className="form-group">
                                                <label>Победител *</label>
                                                <select
                                                    value={matchForm.winnerId}
                                                    onChange={(e) => setMatchForm({...matchForm, winnerId: e.target.value})}
                                                >
                                                    <option value="">Изберете победител</option>
                                                    {selectedPlayer1 && (
                                                        <option value={selectedPlayer1.id}>
                                                            {selectedPlayer1.firstName} {selectedPlayer1.lastName}
                                                        </option>
                                                    )}
                                                    {selectedPlayer2 && (
                                                        <option value={selectedPlayer2.id}>
                                                            {selectedPlayer2.firstName} {selectedPlayer2.lastName}
                                                        </option>
                                                    )}
                                                </select>
                                            </div>
                                            <div className="form-group">
                                                <label>Резултат (например: 3-1, 4-2)</label>
                                                <input
                                                    type="text"
                                                    value={matchForm.score}
                                                    onChange={(e) => setMatchForm({...matchForm, score: e.target.value})}
                                                    placeholder="3-1"
                                                />
                                            </div>
                                        </div>
                                        <button className="btn btn-primary" onClick={addMatch}>
                                            Добави мач
                                        </button>
                                    </div>
                                )}

                                <div className="card">
                                    <h3>Списък на мачовете</h3>
                                    <div className="table-container">
                                        <table>
                                            <thead>
                                                <tr>
                                                    <th>Дата</th>
                                                    <th>Турнир</th>
                                                    <th>Играч 1</th>
                                                    <th>Играч 2</th>
                                                    <th>Победител</th>
                                                    <th>Резултат</th>
                                                    <th>Промяна в точките</th>
                                                    {isAdmin && <th>Действия</th>}
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {matches.map(match => {
                                                    const tournament = tournaments.find(t => t.id === match.tournamentId);
                                                    const player1 = players.find(p => p.id === match.player1Id);
                                                    const player2 = players.find(p => p.id === match.player2Id);
                                                    const winner = players.find(p => p.id === match.winnerId);
                                                    
                                                    return (
                                                        <tr key={match.id}>
                                                            <td>{new Date(match.date).toLocaleDateString('bg-BG')}</td>
                                                            <td>{tournament?.name || '-'}</td>
                                                            <td>{player1 ? `${player1.firstName} ${player1.lastName}` : '-'}</td>
                                                            <td>{player2 ? `${player2.firstName} ${player2.lastName}` : '-'}</td>
                                                            <td><strong>{winner ? `${winner.firstName} ${winner.lastName}` : '-'}</strong></td>
                                                            <td>{match.score || '-'}</td>
                                                            <td>
                                                                {player1 && match.pointsChange[player1.id] && (
                                                                    <div className={match.pointsChange[player1.id] > 0 ? 'points-gain' : 'points-loss'}>
                                                                        {player1.firstName}: {match.pointsChange[player1.id] > 0 ? '+' : ''}{match.pointsChange[player1.id].toFixed(1)}
                                                                    </div>
                                                                )}
                                                                {player2 && match.pointsChange[player2.id] && (
                                                                    <div className={match.pointsChange[player2.id] > 0 ? 'points-gain' : 'points-loss'}>
                                                                        {player2.firstName}: {match.pointsChange[player2.id] > 0 ? '+' : ''}{match.pointsChange[player2.id].toFixed(1)}
                                                                    </div>
                                                                )}
                                                            </td>
                                                            {isAdmin && (
                                                                <td>
                                                                    <button className="btn btn-sm btn-danger" onClick={() => deleteMatch(match.id)}>
                                                                        Изтрий
                                                                    </button>
                                                                </td>
                                                            )}
                                                        </tr>
                                                    );
                                                })}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'history' && (
                            <div>
                                <div className="card">
                                    <h3>Месечна история на ранглистата</h3>
                                    {Object.keys(monthlyRankings).length === 0 ? (
                                        <p>Все още няма запазена история на ранглистата. Стартирайте нов месец, за да запазите текущата ранглиста.</p>
                                    ) : (
                                        Object.entries(monthlyRankings).reverse().map(([month, rankings]) => {
                                            const rankedData = Object.entries(rankings)
                                                .map(([playerId, points]) => ({
                                                    player: players.find(p => p.id === playerId),
                                                    points
                                                }))
                                                .filter(item => item.player)
                                                .sort((a, b) => b.points - a.points);

                                            return (
                                                <div key={month} style={{marginBottom: '30px'}}>
                                                    <h4>Ранглиста за {month}</h4>
                                                    <div className="table-container">
                                                        <table>
                                                            <thead>
                                                                <tr>
                                                                    <th>Позиция</th>
                                                                    <th>Име</th>
                                                                    <th>Фамилия</th>
                                                                    <th>Точки</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                {rankedData.map((item, index) => (
                                                                    <tr key={item.player.id}>
                                                                        <td className="ranking-position">#{index + 1}</td>
                                                                        <td>{item.player.firstName}</td>
                                                                        <td>{item.player.lastName}</td>
                                                                        <td><strong>{item.points.toFixed(1)}</strong></td>
                                                                    </tr>
                                                                ))}
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            );
                                        })
                                    )}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
